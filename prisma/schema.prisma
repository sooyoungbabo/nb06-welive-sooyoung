// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String  @id @default(uuid())
  apartmentId String? //FA

  username   String
  password   String
  contact    String     @unique
  name       String
  email      String     @unique
  avatar     String?
  role       UserType   @default(USER)
  joinStatus JoinStatus @default(PENDING)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // soft delete

  apartment Apartment? @relation(fields: [apartmentId], references: [id], onDelete: SetNull)
  resident  Resident?

  polls             Poll[]
  notices           Notice[]
  complaintAdmins   Complaint[]    @relation(name: "User2Admin")
  complaintCreators Complaint[]    @relation(name: "User2Creator")
  comments          Comment[]
  notifications     Notification[]
  votes             Vote[]

  @@map("users")
}

model Resident {
  id            String  @id @default(uuid())
  userId        String? @unique
  apartmentId   String //FA 
  apartmentDong String // dong
  apartmentHo   String // ho
  contact       String  @unique
  name          String
  email         String?

  isRegistered    Boolean         @default(false) // welive 가입여부
  houseRole       HouseholdRole   @default(HOUSEHOLDER)
  residenceStatus ResidenceStatus @default(RESIDENCE)
  approvalStatus  ApprovalStatus  @default(PENDING) // residentId로 관리자가 가입신청 승인

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // soft delete

  user      User?     @relation(fields: [userId], references: [id])
  apartment Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)

  @@map("residents")
}

model Apartment {
  id           String @id @default(uuid())
  name         String
  address      String
  officeNumber String @unique
  description  String

  startComplexNumber  Int @default(1)
  startBuildingNumber Int @default(1)
  startFloorNumber    Int @default(1)
  startUnitNumber     Int @default(1)
  endComplexNumber    Int
  endBuildingNumber   Int
  endFloorNumber      Int
  endUnitNumber       Int

  apartmentStatus ApprovalStatus @default(PENDING)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime? // soft delete

  users     User[] // users, admim
  residents Resident[] // residents 
  boards    Board[]

  @@unique([name, address])
  @@map("apartments")
}

model Board {
  id          String    @id @default(uuid())
  apartmentId String //FA
  boardType   BoardType

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  apartment  Apartment   @relation(fields: [apartmentId], references: [id])
  complaints Complaint[]
  polls      Poll[]
  notices    Notice[]

  @@unique([apartmentId, boardType])
  @@map("boards")
}

// 마감된 투표는 공지에 자동 등록
model Notice {
  id      String @id @default(uuid())
  boardId String // FK
  adminId String // FK

  category  NoticeType
  isPinned  Boolean    @default(false)
  startDate DateTime?
  endDate   DateTime?
  title     String
  content   String
  viewCount Int        @default(0)
  //commentCount Int        @default(0) // 중복 comments.length
  //writerName String // 중복 admin.name

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // soft delete

  board Board  @relation(fields: [boardId], references: [id])
  admin User   @relation(fields: [adminId], references: [id])
  event Event?

  @@map("notices")
}

model Complaint {
  id        String @id @default(uuid())
  boardId   String //FK
  creatorId String //FK
  adminId   String //FK

  title     String
  content   String
  isPublic  Boolean         @default(true)
  status    ComplaintStatus @default(PENDING)
  viewCount Int             @default(0)
  // commentCount Int // 중복 comments.length
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  deletedAt DateTime? // soft delete

  creator User  @relation(name: "User2Creator", fields: [creatorId], references: [id])
  admin   User  @relation(name: "User2Admin", fields: [adminId], references: [id])
  board   Board @relation(fields: [boardId], references: [id])

  @@map("complaints")
}

model Poll {
  id      String @id @default(uuid())
  boardId String //FK
  adminId String //FK 

  buildingPermission Int        @default(0)
  title              String
  description        String
  startDate          DateTime
  endDate            DateTime
  status             PollStatus

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // soft delete

  admin       User         @relation(fields: [adminId], references: [id])
  board       Board        @relation(fields: [boardId], references: [id])
  votes       Vote[]
  pollOptions PollOption[]
  event       Event?

  @@map("polls")
}

model PollOption {
  id        String   @id @default(uuid())
  pollId    String // FK
  content   String // 각 선택지
  voteCount Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  poll  Poll   @relation(fields: [pollId], references: [id])
  votes Vote[]

  @@map("poll_options")
}

model Vote {
  id        String   @id @default(uuid())
  pollId    String // FK
  optionId  String // FK 선택지
  voterId   String // FK 선택한 사람
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  poll    Poll       @relation(fields: [pollId], references: [id])
  options PollOption @relation(fields: [optionId], references: [id])
  voter   User       @relation(fields: [voterId], references: [id])

  @@unique([pollId, voterId])
  @@map("votes")
}

// 추가 기능: 투표 시작/종료일에 voter에게
// 민원 등록시 admin에게, 민원상태 변경시 작성자에게
// 공지 등록지 입주민 모두에게 
model Notification {
  id         String @id @default(uuid())
  receiverId String //FK

  notiType  NotificationType
  targetId  String
  content   String
  isChecked Boolean          @default(false)

  createdAt DateTime  @default(now())
  checkedAt DateTime? // updatedAt으로 출력해야 함

  receiver User @relation(fields: [receiverId], references: [id])

  @@index([notiType, targetId])
  @@index([receiverId, isChecked])
  @@map("notifications")
}

model Comment {
  id        String @id @default(uuid())
  creatorId String // FA

  targetType CommentType @default(COMPLAINT)
  targetId   String
  content    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creator User @relation(fields: [creatorId], references: [id])

  @@index([targetType, targetId])
  @@map("comments")
}

model Event {
  id        String    @id @default(uuid())
  pollId    String?   @unique //FA
  noticeId  String?   @unique //FA
  eventType EventType @default(NOTICE)
  title     String // notice.title 또는 poll.title
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  notice Notice? @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  poll   Poll?   @relation(fields: [pollId], references: [id], onDelete: Cascade)

  @@map("events")
}

enum UserType {
  SUPER_ADMIN
  ADMIN
  USER
}

enum JoinStatus {
  PENDING
  APPROVED
  REJECTED
  NEED_UPDATE
  MOVED_OUT
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ResidenceStatus {
  RESIDENCE
  NO_RESIDENCE
}

enum HouseholdRole {
  HOUSEHOLDER
  MEMBER
}

enum ComplaintStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
}

enum PollStatus {
  UPCOMING
  ONGOING
  CLOSED
}

enum NoticeType {
  MAINTENANCE
  EMERGENCY
  COMMUNITY
  RESIDENT_VOTE
  RESIDENT_COUNCIL
  ETC
}

enum BoardType {
  NOTICE
  POLL
  COMPLAINT
}

enum CommentType {
  NOTICE
  COMPLAINT
}

enum NotificationType {
  ADMIN_APPLIED
  USER_APPLIED
  NOTICE
  COMPLAINT_RAISED
  COMPLAINT_RESOLVED
  POLL_START
  POLL_CLOSED
}

enum EventType {
  POLL
  NOTICE
}
